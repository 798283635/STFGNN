# AAAI-2021 Spatial-Temporal Fusion Graph Neural Networks for Traffic Flow Forecasting
<p align="center">
  <img width="800" height="400" src=./documents/stfgnn.png>
</p>

## Requirements
This is the MXNet implementation of STFGNN in the paper: [Spatial-Temporal Fusion Graph Neural Networks for Traffic Flow Forecasting, AAAI 2021] (https://arxiv.org/abs/2012.09641). 
This framework is built based on framework of [STSGCN(AAAI-20)](https://github.com/Davidham3/STSGCN). Being familiar with its pipeline is strongly recommended. 
- python 3
- see `requirements.txt`
## Data Preparation
STFGNN is implemented on eight public traffic datasets.
- **METR-LA** and **PEMS-BAY** from [DCRNN (ICLR-18)](https://github.com/liyaguang/DCRNN).
Download the data from [Google Drive](https://drive.google.com/open?id=10FOTa6HXPqX8Pf5WRoRwcFnW9BrNZEIX) or [Baidu Yun](https://pan.baidu.com/s/14Yy9isAIZYdU__OYEQGa_g).

Then using preprocessing pipeline form [Graph WaveNet (IJCAI-19)](https://github.com/nnzhan/Graph-WaveNet):
```
# Create data directories
mkdir -p data/{METR-LA,PEMS-BAY}

# METR-LA
python generate_training_data.py --output_dir=data/METR-LA --traffic_df_filename=data/metr-la.h5

# PEMS-BAY
python generate_training_data.py --output_dir=data/PEMS-BAY --traffic_df_filename=data/pems-bay.h5

```

- **PEMS03**, **PEMS04**, **PEMS07** and **PEMS08** from [STSGCN (AAAI-20)](https://github.com/Davidham3/STSGCN).
Download the data [STSGCN_data.tar.gz](https://pan.baidu.com/s/1ZPIiOM__r1TRlmY4YGlolw) with password: `p72z` and uncompress data file using`tar -zxvf data.tar.gz`

- **PeMSD7(Middle)** and **PeMSD7(Large)** from [STGCN (IJCAI-18)](https://github.com/VeritasYin/STGCN_IJCAI-18).
Download the data [PeMSD7_data.zip](https://pan.baidu.com/s/1fNz0powVkm9mNUjLoIX30w) with password: `9527` and uncompress data file using`unzip PeMSD7_data.zip`

## Temporal Graph Construction
The temporal graph of eight traffic dataset are available at `./data/adj_xxx_00x.csv`. If traffic data is available, its temporal graph could also be generated by code:
```
cd ./data/
python fastDTW_adj_gen.py
```

## Model Training
METR-LA and PEMS-BAY:
```
python main_4n0_3layer_12T_712_res_npz.py --config config/XXXX/individual_3layer_12T.json
```

PEMS03, PEMS04, PEMS07, PEMS08 and PeMSD7M, PeMSD7L:
```
python main_4n0_3layer_12T_res.py --config config/XXXX/individual_3layer_12T.json
```
## Acknowledgments
The authors would like to thank [Prof Huaiyu Wan](http://scit.bjtu.edu.cn/cms/staff/8793/?cat=102) for his nice email interaction during submission of this paper, also like to thank [Chao Song](https://github.com/Davidham3) for his great mxnet implementation of [STSGCN](https://github.com/Davidham3/STSGCN).
